{"version":1,"ops":[{"type":3,"author":{"id":"6a0aeab8ae8e7bf93407c51e9b2a4d9d0273c9ad"},"timestamp":1564107932,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUxNTI4Mzg3Mw==","github-url":"https://github.com/fraction/oasis/issues/6#issuecomment-515283873"},"message":"Looks like this might happen when indexes are behind.","files":null},{"type":3,"author":{"id":"71f5fe2fc3d873c514cc4e11fefec5167f91dbe0"},"timestamp":1565637387,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMDU1ODQwNA==","github-url":"https://github.com/fraction/oasis/issues/6#issuecomment-520558404"},"message":"I'm seeing the same error as above consistently with a pre-launched `ssb-server`.\n\nAny known workaround?\n\nThis is with oasis and ssb-server installed via `npm install`.\n\nThere are no additional plugins enabled in my `.ssb/config`.","files":null},{"type":3,"author":{"id":"6a0aeab8ae8e7bf93407c51e9b2a4d9d0273c9ad"},"timestamp":1565640578,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMDU3NTgxOQ==","github-url":"https://github.com/fraction/oasis/issues/6#issuecomment-520575819"},"message":"@khimaros \n\nI think this is actually just happening when your indexes are behind. Could you run `ssb-server status` in another tab? The `progress` and `sync` keys are the ones you're looking for, when it's up-to-date it should look like:\n\n```json\n{\n  \"progress\": {\n    \"indexes\": {\n      \"start\": 707179111,\n      \"current\": 707179111,\n      \"target\": 707179111\n    }\n  },\n  \"sync\": {\n    \"since\": 707179111,\n    \"plugins\": {\n      \"last\": 707179111,\n      \"keys\": 707179111,\n      \"clock\": 707179111,\n      \"time\": 707179111,\n      \"feed\": 707179111,\n      \"backlinks--oaWWDs8g\": 707179111,\n      \"private--oaWWDs8g\": 707179111,\n      \"query\": 707179111,\n      \"search\": 707179111,\n      \"tags\": 707179111,\n      \"patchwork-subscriptions\": 707179111,\n      \"patchwork-channels\": 707179111,\n      \"patchwork-contacts\": 707179111\n    },\n    \"sync\": true\n  },\n}","files":null},{"type":3,"author":{"id":"71f5fe2fc3d873c514cc4e11fefec5167f91dbe0"},"timestamp":1565656363,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMDY0NDI0OA==","github-url":"https://github.com/fraction/oasis/issues/6#issuecomment-520644248"},"message":"Thank you for your help. This is a ssb-server with a very small number of follows. Index seems to be fully up to date:\n\n```\n{\n  \"progress\": {\n    \"indexes\": {\n      \"start\": 14535,\n      \"current\": 14535,\n      \"target\": 14535\n    }\n  },\n  \"sync\": {\n    \"since\": 14535,\n    \"plugins\": {\n      \"last\": 14535,\n      \"keys\": 14535,\n      \"clock\": 14535,\n      \"time\": 14535,\n      \"feed\": 14535,\n      \"contacts2\": 14535,\n      \"query\": 14535,\n      \"links2\": 14535,\n      \"backlinks-9O_u9-zjR\": 14535\n    },\n    \"sync\": true\n  },\n  \"gossip\": {},\n  \"ooo\": {}\n}\n```\n\nUpon closer reading of this issue, I realize I may be encountering a different problem. The error I am seeing is not on startup, but rather when I hit any endpoint except `/status`:\n\n```\n2019-08-13T00:12:17.303928137Z 2019-08-13T00:12:17.303Z koa-router GET /\n2019-08-13T00:12:17.438732254Z 2019-08-13T00:12:17.438Z oasis:model-post transforming %ExpI\u003celided\u003e\n2019-08-13T00:12:17.438921539Z 2019-08-13T00:12:17.438Z oasis:model-post transforming %/gHW\u003celided\u003e\n2019-08-13T00:12:17.439167016Z 2019-08-13T00:12:17.438Z oasis:model-post transforming %r92/\u003celided\u003e\n2019-08-13T00:12:17.439281364Z 2019-08-13T00:12:17.439Z oasis:model-post transforming %Gavf\u003celided\u003e\n2019-08-13T00:12:17.439524190Z 2019-08-13T00:12:17.439Z oasis:model-post transforming %XTxv\u003celided\u003e\n2019-08-13T00:12:17.442729528Z \n2019-08-13T00:12:17.442852390Z   TypeError: Cannot read property 'read' of undefined\n2019-08-13T00:12:17.442873479Z       at Promise.all.messages.map (/srv/export/node_modules/@fraction/oasis/src/pages/models/post.js:28:59)\n2019-08-13T00:12:17.442883593Z       at Array.map (\u003canonymous\u003e)\n2019-08-13T00:12:17.442892838Z       at transform (/srv/export/node_modules/@fraction/oasis/src/pages/models/post.js:11:69)\n2019-08-13T00:12:17.442902348Z       at pull.collect (/srv/export/node_modules/@fraction/oasis/src/pages/models/post.js:224:19)\n2019-08-13T00:12:17.442911120Z       at /srv/export/node_modules/pull-stream/sinks/reduce.js:10:5\n2019-08-13T00:12:17.442919966Z       at /srv/export/node_modules/pull-stream/sinks/drain.js:20:24\n2019-08-13T00:12:17.442927721Z       at PacketStreamSubstream.weird.read (/srv/export/node_modules/muxrpc/pull-weird.js:33:7)\n2019-08-13T00:12:17.442951519Z       at PacketStream._onstream (/srv/export/node_modules/packet-stream/index.js:200:12)\n2019-08-13T00:12:17.442960956Z       at PacketStream.write (/srv/export/node_modules/packet-stream/index.js:135:41)\n2019-08-13T00:12:17.442969363Z       at /srv/export/node_modules/muxrpc/pull-weird.js:56:15\n```\n\nThe keys mentioned are `private-box` messages of the form:\n\n```\n{\n  \"key\": \"%ExpI\u003celided\u003e\",\n  \"value\": {\n    \"previous\": \"%eJlD\u003celided\u003e\",\n    \"author\": \"@TXRu\u003celided\u003e\",\n    \"sequence\": 6,\n    \"timestamp\": 1556246549084,\n    \"hash\": \"sha256\",\n    \"content\": {\n      \"text\": \"\u003celided\u003e\",\n      \"type\": \"post\",\n      \"root\": \"%/gHW\u003celided\u003e\",\n      \"mentions\": []\n    },\n    \"signature\": \"\u003celided\u003e\"\n  },\n  \"timestamp\": 1556246550191\n}\n{\n  \"key\": \"%/gHW\u003celided\u003e\",\n  \"value\": {\n    \"previous\": \"%r92/\u003celided\u003e\",\n    \"author\": \"@Z87k\u003celided\u003e\",\n    \"sequence\": 7,\n    \"timestamp\": 1556246286171,\n    \"hash\": \"sha256\",\n    \"content\": {\n      \"text\": \"\u003celided\u003e\",\n      \"type\": \"post\",\n      \"mentions\": []\n    },\n    \"signature\": \"\u003celided\u003e\"\n  },\n  \"timestamp\": 1556246286929\n}\n{\n  \"key\": \"%r92/\u003celided\u003e\",\n  \"value\": {\n    \"previous\": \"%Gavf\u003celided\u003e\",\n    \"author\": \"@Z87k\u003celided\u003e\",\n    \"sequence\": 6,\n    \"timestamp\": 1556246247428,\n    \"hash\": \"sha256\",\n    \"content\": {\n      \"text\": \"\u003celided\u003e\",\n      \"type\": \"post\",\n      \"root\": \"%XTxv\u003celided\u003e\",\n      \"mentions\": []\n    },\n    \"signature\": \"\u003celided\u003e\"\n  },\n  \"timestamp\": 1556246248190\n}\n{\n  \"key\": \"%Gavf\u003celided\u003e\",\n  \"value\": {\n    \"previous\": \"%T1kc\u003celided\u003e\",\n    \"author\": \"@Z87k\u003celided\u003e\",\n    \"sequence\": 5,\n    \"timestamp\": 1556246226062,\n    \"hash\": \"sha256\",\n    \"content\": {\n      \"text\": \"\u003celided\u003e\",\n      \"type\": \"post\",\n      \"mentions\": []\n    },\n    \"signature\": \"\u003celided\u003e\"\n  },\n  \"timestamp\": 1556246226836\n}\n\n{\n  \"key\": \"%XTxv\u003celided\u003e\",\n  \"value\": {\n    \"previous\": \"%WLjE\u003celided\u003e\",\n    \"author\": \"@TXRu\u003celided\u003e\",\n    \"sequence\": 4,\n    \"timestamp\": 1556245935669,\n    \"hash\": \"sha256\",\n    \"content\": {\n      \"text\": \"\u003celided\u003e\",\n      \"type\": \"post\",\n      \"mentions\": []\n    },\n    \"signature\": \"\u003celided\u003e\"\n  },\n  \"timestamp\": 1556245936827\n}\n```\n\nFWIW, I'm able to interact with the same server using `patchfoo` without issue.","files":null},{"type":3,"author":{"id":"6a0aeab8ae8e7bf93407c51e9b2a4d9d0273c9ad"},"timestamp":1565669576,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMDY4MTY5MA==","github-url":"https://github.com/fraction/oasis/issues/6#issuecomment-520681690"},"message":"Oh, totally different issue. I think I've fixed this in the 15.0.1 upgrade, could you confirm that the fix resolves this bug for you?","files":null},{"type":5,"author":{"id":"6a0aeab8ae8e7bf93407c51e9b2a4d9d0273c9ad"},"timestamp":1565669695,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDI1NTIxMTU3MTE="},"added":["topic:bug"],"removed":[]},{"type":3,"author":{"id":"71f5fe2fc3d873c514cc4e11fefec5167f91dbe0"},"timestamp":1565674988,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMDY5NjU4OA==","github-url":"https://github.com/fraction/oasis/issues/6#issuecomment-520696588"},"message":"@christianbundy -- I couldn't find a 15.0.1 but did try oasis 1.15.1.\n\n```\n$ /srv/export/node_modules/.bin/oasis --version\n1.15.1\n```\n\nThe symptom with this version seems to be the same.\n\nThis is the line where the exception is being raised:\n\n```\n  const referenceStream = await cooler.read(ssb.backlinks.read, {\n```\n\nFrom a glance it wasn't clear whether `cooler` or `ssb.backlinks` was undefined, so I added a few debug statements:\n\n```\n2019-08-13T05:39:50.514206358Z 2019-08-13T05:39:50.514Z oasis:model-post cooler [object Object]\n2019-08-13T05:39:50.514281137Z 2019-08-13T05:39:50.514Z oasis:model-post ssb.backlinks undefined\n```\n\nLooks like something is amiss with `ssb-backlinks` on my system?","files":null},{"type":3,"author":{"id":"6a0aeab8ae8e7bf93407c51e9b2a4d9d0273c9ad"},"timestamp":1565708264,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMDg3MTEzNA==","github-url":"https://github.com/fraction/oasis/issues/7#issuecomment-520871134"},"message":"And just to be clear, this is when Oasis is started with the internal or external server? I just noticed that I could trigger this by starting an external server, starting Oasis, and then killing the external server. Seems to me like maybe it was previously connected to an external server?","files":null},{"type":3,"author":{"id":"71f5fe2fc3d873c514cc4e11fefec5167f91dbe0"},"timestamp":1565710164,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMDg4NDY0Mg==","github-url":"https://github.com/fraction/oasis/issues/7#issuecomment-520884642"},"message":"This is when starting without an external server. The external server is never running during the lifecycle of the oasis process. Interestingly, I can see the 8008 ports open on the oasis pid, so the server is there but maybe not responsive?","files":null},{"type":3,"author":{"id":"6a0aeab8ae8e7bf93407c51e9b2a4d9d0273c9ad"},"timestamp":1565814122,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMTQwMzY0Mg==","github-url":"https://github.com/fraction/oasis/issues/7#issuecomment-521403642"},"message":"I think this issue is resolved as well, could you try the latest code when you've got some free time? Thanks for all the help debugging! :crossed_fingers:","files":null},{"type":3,"author":{"id":"71f5fe2fc3d873c514cc4e11fefec5167f91dbe0"},"timestamp":1565993862,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMjE2ODI3MA==","github-url":"https://github.com/fraction/oasis/issues/7#issuecomment-522168270"},"message":"cold start was successful 5/5 times, looks like this is in good shape as well!","files":null},{"type":3,"author":{"id":"71f5fe2fc3d873c514cc4e11fefec5167f91dbe0"},"timestamp":1565993973,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMjE2ODY0Nw==","github-url":"https://github.com/fraction/oasis/issues/7#issuecomment-522168647"},"message":"For my own education, which PR do you suspect fixed this one?","files":null},{"type":3,"author":{"id":"6a0aeab8ae8e7bf93407c51e9b2a4d9d0273c9ad"},"timestamp":1566177235,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUyMjM3Nzg4NQ==","github-url":"https://github.com/fraction/oasis/issues/7#issuecomment-522377885"},"message":"My best guess is that it came from here: https://github.com/fraction/oasis/commit/fb047f7e604289ef143cf0ce302c9f1dfe86ad2c, specifically from reordering these lines:\n\nhttps://github.com/fraction/oasis/blob/fb047f7e604289ef143cf0ce302c9f1dfe86ad2c/src/pages/models/lib/cooler.js#L10-L31\n\nThere are some weird janky issues that can occur when you add one plugin before another (!), but it seems to work when I order them alphabetically *as long as ssb-db and ssb-replicate are loaded first*. There are lots of shadows bugs hidden in the ordering of [secret-stack plugins](https://github.com/ssbc/secret-stack/blob/master/PLUGINS.md). :confused:","files":null},{"type":4,"author":{"id":"6a0aeab8ae8e7bf93407c51e9b2a4d9d0273c9ad"},"timestamp":1566177235,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50MjU2NDc5ODkwMA=="},"status":2},{"type":3,"author":{"id":"4f506d936028410197b6fff70b94c3833432a95b"},"timestamp":1578337192,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU3MTI2NTk5NQ==","github-url":"https://github.com/fraction/oasis/issues/7#issuecomment-571265995"},"message":"Might be related to #40","files":null}]}